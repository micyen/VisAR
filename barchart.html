<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="./styles/style.css">
        <link rel="stylesheet" href="./styles/barchart_styles.css">
        <!-- <script src="https://unpkg.com/d3@5.6.0/dist/d3.min.js">
        </script> -->
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/d3-scale@4"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css">
        <!-- <script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script> -->
        <!-- <script src="https://cdn.jsdelivr.net/npm/d3-array@3/+esm"></script> -->
    </head>
    <body id="main">
        <div class="sidenav">
            <a href="./dashboard.html">
                <img src="imgs/Home_Icon.svg" alt="Home Icon" style="width:50px;height:50px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    Home
                </div>
            </a>
            <a href="./forcegraph.html">
                <img src="imgs/Graph_Icon.svg" alt="Bipartite Icon" style="width:100px;height:100px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    Graph
                </div>
            </a>
            <a href="./treemap.html">
                <img src="imgs/Treemap_Icon.svg" alt="Treemap Icon" style="width:100px;height:100px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    Treemap
                </div>
            </a>
            <a href="./barchart.html">
                <img src="imgs/Barchart_Icon.svg" alt="Barchart Icon" style="width:100px;height:100px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    Bar Chart
                </div>
            </a>
            <a href="./about.html">
                <img src="imgs/Info_Icon.svg" alt="About Icon" style="width:50px;height:50px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    About
                </div>
            </a>
        </div>
        <div class="centerdiv">
            <div class="header">
                <h1>
                    VisAR
                </h1>
            </div>
            <div class="menu" id="menu"></div>
            <div class="body" id="charts"></div>
        </div>
    </body>
</html>

<script type="module">

    import {range} from "https://cdn.jsdelivr.net/npm/d3-array@3/+esm";

    // document.getElementById("newchart").addEventListener("click", addChart);
    // startChart('Acetaminophen');
    selectDrugInitiate();

    function selectDrugInitiate() {

        fetch('http://ec2-44-212-66-70.compute-1.amazonaws.com:5000/drugList')
        .then((response) => response.json())
        .then((json) => {
            var druglist = JSON.parse(json['body']);
            const parent = document.getElementById("charts");
            const menu = document.getElementById("menu");
            menu.replaceChildren();
            parent.replaceChildren();

            const select = document.createElement("select");
            select.id = "drug";

            const drugLabel = document.createElement('label');
            drugLabel.textContent = 'Drug: ';
            drugLabel.appendChild(select);

            menu.appendChild(drugLabel);

            for (var i = 0; i < druglist.length; i++) {
                var option = document.createElement("option");
                option.value = druglist[i];
                option.text = druglist[i];
                select.appendChild(option);
            }

            const button = document.createElement("button");
            button.onclick = () => {
                const selection = document.getElementById("drug").value;
                startChart(selection)
            }
            button.id = "submit";
            button.innerText = "Submit";
            menu.appendChild(document.createElement('br'));
            menu.appendChild(document.createElement('br'));
            menu.appendChild(button);
        });
    }

    function startChart(drug) {

        const titleText = `Adverse Effects for ${drug}`;
        const xAxisLabelText = 'Count';
               
        const parent = d3.select("#charts");
        const menu = d3.select("#menu");

        var max = 0;
        
        parent
            .selectAll('*')
            .remove();

        menu
            .selectAll('*')
            .remove();

        menu
            .append("button")
            .on("click", selectDrugInitiate)
            .attr("class", "back")
            .text("Back")
            // .style("position", "float")

        const sliderDiv = menu.append('div')
            .style('width', 'auto')
            .style('height', '150px')
            .style('padding-top', '10px')
            .style('text-align', 'center')
            .attr('id', 'sliders');

        const zoomLabel = sliderDiv.append('label')
            .attr('id', 'zoomLabel')
            .html('Zoom');

        zoomLabel.append('div')
            .style('width', 'auto')
            .style('height', '0px');

        const zoomSlider = zoomLabel.append('input')
            .attr('id', 'zoom')
            .attr('type', 'range')
            .attr('min', 0.01)
            .attr('max', 2)
            .attr('value', 1)
            .attr('step', 0.01);

        sliderDiv.append('div')
            .style('width', 'auto')
            .style('height', '20px');

        const rangeLabel = sliderDiv.append('label')
            .attr('id', 'rangeLabel')
            .html('Select Minimum and Maximum Count to Display');
        
        rangeLabel.append('div')
            .style('width', 'auto');
            // .style('height', '10px')

        const rangeSlider = rangeLabel.append('div')
            .style('width', 'auto')
            .style('height', '20px')
            .style('text-align', 'center')
            .attr('class', 'noUiSlider')
            .style('margin-left', '200px')
            .style('margin-right', '200px')
            .attr('id', 'rangeSlider');

        const noUiRangeSlider = document.getElementById('rangeSlider');

        noUiSlider.create(noUiRangeSlider, {
            range: {
                'min': 0,
                'max': max
            },
            step: 1,
            start: [0, max],
            margin: 0, 
            limit: max,
            connect: true,
            direction: 'ltr',
            orientation: 'horizontal',

            behavior: 'tap-drag',
            tooltips: true,

            // pips: {
            //     mode: 'steps',
            //     stepped: true,
            //     density: 4
            // }
        })

        parent.append("svg")
            .attr("width",  "1200")
            .attr("height", "600")
            .attr("id", "svg_chart")
            .style('pointer-events', 'none')
            .style('position', 'absolute')
            .style('z-index', 1);

        const svg = d3.select("#svg_chart");
        const width = +svg.attr("width");
        const height = +svg.attr("height");

        const render = data => {

            data.sort(function (a, b) {
                if (a.Count < b.Count) {
                    return 1;
                }
                if (a.Count > b.Count) {
                    return -1;
                }
                return 0;
            })

            const countsData = data.map((o) => o.Count)
            max = Math.max(countsData.reduce((a, b) => Math.max(a, b), -Infinity))

            noUiRangeSlider.noUiSlider.updateOptions({
                range: {
                    'min': 0,
                    'max': max
                },
                step: 1,
                start: [0, max],
                margin: 0, 
                limit: max,
                connect: true,
                direction: 'ltr',
                orientation: 'horizontal',

                behavior: 'tap-drag',
                tooltips: true,

                // pips: {
                //     mode: 'steps',
                //     stepped: true,
                //     density: 4
                // }
            }); 

            const sortData = (type) => {

                if (type === 'descending'){
                    data = data.sort(function (a, b) {
                        if (a.Count < b.Count) {
                            return 1;
                        }
                        if (a.Count > b.Count) {
                            return -1;
                        }
                        return 0;
                    })
                }
                else {
                    data = data.sort(function (a, b) {
                        if (a.Count > b.Count) {
                            return 1;
                        }
                        if (a.Count < b.Count) {
                            return -1;
                        }
                        return 0;
                    })
                }

                const filterRange = noUiRangeSlider.noUiSlider.get();
                
                var filteredData = data.filter(function(o) {
                    return o.Count >= filterRange[0] && o.Count <= filterRange[1];
                });   


                overHeight = filteredData.length * 50 + margin.left + margin.right;
                range = d3.range(0, overHeight * (filteredData.length + 1), overHeight);

                xScale
                    .domain([0, d3.max(filteredData, xValue)])
                    .range([0, innerWidth]);

                yScale
                    .domain(filteredData.map(yValue))
                    .range(range)

                const inner_svg_new = d3.select('#inner_svg')
                    .attr("height", overHeight + "px")

                d3.select('#xAxis').call(xAxis);
                const g2_new = d3.select('#g2');

                g2_new.selectAll("#yAxis").call(yAxis);

                g2_new.selectAll('rect')
                    .remove()

                g2_new.selectAll('mybar')
                    .remove()
                    .data(filteredData)
                    .join('rect')
                        .attr('y', d => yScale(yValue(d)))
                        .attr('height', d => yScale.bandwidth())
                        .attr('x', d => 0) 
                        .attr('width', d => 0)
                        .attr('id', d => d["manufacturer"])
                        .attr("fill", function(d,i) {
                            return color(i);
                        })
                    .on("mouseover", (_, d) => {mouseover(d)})
                    .on("mousemove", (e, d) => {mousemove(e, d)})
                    .on("mouseleave", (_, d) => {mouseleave(d)})
                    .on("click", (_, d) => {mouseclick(d)});

                g2_new.selectAll('rect')
                    .transition()
                    .duration(1000)
                    .attr('x', d => 0)
                    .attr('width', d => xScale(xValue(d)));

                zoomSlider.node().value = 1
            }

            const maxRadio = document.createElement('input');
            maxRadio.type = 'radio';
            maxRadio.id = 'descending';
            maxRadio.name = 'sortBy';
            maxRadio.value = 'descending';
            maxRadio.checked = 'checked';
            maxRadio.addEventListener("change", (event) => {
                sortData('descending')
            }) 

            const maxRadioLabel = document.createElement("label");
            maxRadioLabel.innerText = 'Sort Descending Count';
            maxRadioLabel.for = 'maxRadio';
            maxRadioLabel.className = 'radioLabel';

            const minRadio = document.createElement('input');
            minRadio.type = 'radio';
            minRadio.id = 'ascending';
            minRadio.name = 'sortBy';
            minRadio.value = 'ascending';
            minRadio.addEventListener("change", (event) => {
                sortData('ascending')
            }) 
            const minRadioLabel = document.createElement("label");
            minRadioLabel.innerText = 'Sort Ascending Count';
            minRadioLabel.for = 'minRadio';
            minRadioLabel.className = 'radioLabel';

            const radioGroupSort = document.createElement("div");
            radioGroupSort.className = 'radioGroup'

            const menuDOM = document.getElementById('menu')

            radioGroupSort.append(maxRadioLabel);
            maxRadioLabel.append(maxRadio);
            radioGroupSort.append(minRadioLabel);
            minRadioLabel.append(minRadio);
            menuDOM.append(radioGroupSort);

            const yValue = d => d['AE'];
            const xValue = d => d['Count'];

            const margin = { top: 50, right: 40, bottom: 77, left: 300 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            var overHeight = data.length * 50 + margin.left + margin.right;

            const xScale = d3.scaleLinear()
                .domain([0, d3.max(data, xValue)])
                .range([0, innerWidth]);

            // const yScale = d3.scaleBand()
            //     .domain(data.map(yValue))
            //     .range([0, innerHeight])
            //     .padding(0.1);

            // const range = d3.range(0, (data.length + 1) * 15000, 15000);
            var range = d3.range(0, overHeight * (data.length + 1), overHeight);

            const yScale = d3.scaleBand()
                .domain(data.map(yValue))
                .range(range)
                .paddingInner(0.1)
                .paddingOuter(0.1);

            const g = svg.append('g')
                .attr('id', 'g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            console.log(`translate(${margin.left},${margin.top})`)

            const xAxis = d3.axisBottom(xScale)
                .tickSize(-innerHeight)
                .ticks(5);

            const xAxisG = g.append('g')
                .attr('id', 'xAxis')
                .call(xAxis)
                .attr('transform', `translate(0,${innerHeight})`);
            console.log(`translate(0,${innerHeight})`)

            g.append('text')
                .attr('class', 'title')
                .attr('y', -10)
                .text(titleText);

            xAxisG.append('text')
                .attr('class', 'axis-label')
                .attr('y', 65)
                .attr('x', innerWidth / 2)
                .attr('fill', 'black')
                .text(xAxisLabelText);

            const filler = parent.append('div')
                .style('width', '1200px')
                .style('height', margin.top + 'px')
                .attr('id', 'filler');
            
            const body = parent.append('div')
                .style('overflow-y', 'scroll')
                .style('overflow-x', 'hidden')
                .style('width', '1200px')
                .style('height', innerHeight + "px")
                .attr('id', 'scroll');

            const inner_svg = body.append('svg')
                .attr("width",  "1200px")
                .attr("height", overHeight + "px")
                .attr('id', 'inner_svg')
                .style('display', 'block');

            const g2 = inner_svg.append('g')
                .attr('id', 'g2')
                .attr('transform', `translate(${margin.left},0)`);

            const yAxis = d3.axisLeft(yScale)

            const yAxisG = g2.append('g')
                .attr('id', 'yAxis')
                .call(yAxis)
                .selectAll('.domain, .tick line').remove();
            
            var tooltip = d3.select('#main')
                .append("div")
                // .style("opacity", 0)
                .style("visibility", "hidden")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "1px")
                .style("border-radius", "5px")
                .style("position", "absolute")
                .style("z-index", 2)
                .style("padding", "10px");

            var mouseover = function(d) {
                tooltip
                    // .html("subgroup: " + subgroupName + "<br>" + "Value: " + subgroupValue)
                    .html("Adverse Effect: " + d["AE"] + "<br>" + "Count: " + d["Count"])
                    // .style("opacity", 1)
                    .style("visibility", "visible");
            };

            var mousemove = function(e, d) {
                tooltip
                    .style("left", (e.pageX + 30) + "px")
                    .style("top", (e.pageY) + "px");
            };

            var mouseleave = function(d) {
                tooltip
                    // .style("opacity", 0)
                    .style("visibility", "hidden");
            };

            var mouseclick = function(d) {
                tooltip
                    // .style("opacity", 0)
                    .style("visibility", "hidden");
                addChart(drug, d["AE"]);
            }

            var color = d3.scaleOrdinal([`#383867`, `#584c77`, `#33431e`, `#a36629`, `#92462f`, `#b63e36`, `#b74a70`, `#946943`]);

            g2.selectAll('mybar')
                .data(data)
                .join('rect')
                    .attr('y', d => yScale(yValue(d)))
                    .attr('height', d => yScale.bandwidth())
                    .attr('x', d => 0) 
                    .attr('width', d => 0)
                    .attr('id', d => d['AE'])
                    .style("cursor", "pointer")
                    .attr("fill", function(d,i) {
                        return color(i);
                    })
                .on("mouseover", (_, d) => {mouseover(d)})
                .on("mousemove", (e, d) => {mousemove(e, d)})
                .on("mouseleave", (_, d) => {mouseleave(d)})
                .on("click", (_, d) => {mouseclick(d)});

            // g.selectAll('rect').data(data)
            //     .enter().append('rect')
            //         .attr('y', d => yScale(yValue(d)))
            //         .attr('width', d => xScale(xValue(d)))
            //         .attr('height', yScale.bandwidth());

            g2.selectAll('rect')
                .transition()
                .duration(1000)
                .attr('x', d => 0)
                .attr('width', d => xScale(xValue(d)))

            // TODO: possibly remove axis labels if too small
            function zoomed(value) {
                const new_range = range.map((d) => { return d * value });
                console.log(new_range);
                yScale.range(new_range);
                const new_svg = d3.select('#inner_svg')
                    .attr("height", overHeight * value + "px")
                new_svg.selectAll("rect")
                    .transition()
                    .duration(1000)
                    .attr("y", d => yScale(yValue(d)))
                    .attr("height", yScale.bandwidth());

                //TODO: remove labels if value is bigger than a certain value?
                if(value > 0.5){
                    new_svg.selectAll("#yAxis").call(yAxis);
                }
                else {
                    new_svg.selectAll("#yAxis").call(yAxis);
                }
            }

            zoomSlider.on('change', () => {
                zoomed(zoomSlider.node().value)
            })

            function changeRange(values, handle, unencoded, tap, positions, noUiSlider) {
            // values: Current slider values (array);
            // handle: Handle that caused the event (number);
            // unencoded: Slider values without formatting (array);
            // tap: Event was caused by the user tapping the slider (boolean);
            // positions: Left offset of the handles (array);
            // noUiSlider: slider public Api (noUiSlider);

            //TODO: display filtered data
                const filterRange = values;
                var filteredData = data.filter(function(o) {
                    return o.Count >= filterRange[0] && o.Count <= filterRange[1];
                });

                overHeight = filteredData.length * 50 + margin.left + margin.right;
                range = d3.range(0, overHeight * (data.length + 1), overHeight);

                xScale
                    .domain([0, d3.max(filteredData, xValue)])
                    .range([0, innerWidth]);
                
                yScale
                    .domain(filteredData.map(yValue))
                    .range(range)

                const inner_svg_new = d3.select('#inner_svg')
                    .attr("height", overHeight + "px")
                
                d3.select('#xAxis').call(xAxis);
                const g2_new = d3.select('#g2');

                g2_new.selectAll("#yAxis").call(yAxis);

                g2_new.selectAll('rect')
                    .remove()

                g2_new.selectAll('mybar')
                    .remove()
                    .data(filteredData)
                    .join('rect')
                        .attr('y', d => yScale(yValue(d)))
                        .attr('height', d => yScale.bandwidth())
                        .attr('x', d => 0) 
                        .attr('width', d => 0)
                        .attr('id', d => d['AE'])
                        .style("cursor", "pointer")
                        .attr("fill", function(d,i) {
                            return color(i);
                        })
                    .on("mouseover", (_, d) => {mouseover(d)})
                    .on("mousemove", (e, d) => {mousemove(e, d)})
                    .on("mouseleave", (_, d) => {mouseleave(d)})
                    .on("click", (_, d) => {mouseclick(d)});

                g2_new.selectAll('rect')
                    .transition()
                    .duration(1000)
                    .attr('x', d => 0)
                    .attr('width', d => xScale(xValue(d)))

                zoomSlider.node().value = 1

            }
            noUiRangeSlider.noUiSlider.on('change', changeRange);
        };
        
         // d3.csv('./data/BarChart_ACETAMINOPHEN_all.csv').then(data => {
        // d3.csv(`https://faers-proj.s3.amazonaws.com/BarChart/BarData${drug}_all.csv`).then(data => {
        //     var aggr_data = {}
        //     var aggr_data_list = []
        //     function aggregate(_callback){
        //         Object.entries(data).forEach((entry) => {
        //             const ae = entry[1]['Adverse Event'];
        //             const count = entry[1]['Count'];
        //             if (ae in aggr_data) {
        //                 aggr_data[ae] += +count;
        //             }
        //             else {
        //                 aggr_data[ae] = +count;
        //             }
        //         });
        //         aggr_data_list = Object.keys(aggr_data).sort().map((key) => ({'AE': key, 'Count': +aggr_data[key]}));
        //         aggr_data_list = aggr_data_list.filter(d => {
        //             // Number.isNaN(o.Count)
        //             return d.AE !== 'undefined';
        //         })
        //         console.log(aggr_data_list)
        //         _callback();
        //     }

        //     function aggregate2(){
        //         aggregate(function() {
        //             console.log(aggr_data_list);
        //             render(aggr_data_list);
        //         })
        //     }

        //     aggregate2();
        //     // filteredData.forEach(d => {
        //     //     d.Count = +d.Count;
        //     // });
        //     // render(aggr_data);
        // });

        fetch('http://ec2-44-212-66-70.compute-1.amazonaws.com:5000/barChartMain', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({"drug": drug})
        })
        .then((response) => response.json())
        .then((json) => {
            const data = JSON.parse(json['body'])
            data.forEach(d => {
                d.Count = +d.Count;
            });
            render(data.sort(function (a, b) {
                if (a.manufacturer < b.manufacturer) {
                    return -1;
                }
                if (a.manufacturer > b.manufacturer) {
                    return 1;
                }
                return 0;
            }));
        });
    }

    function addChart(drug, ae) {

        const titleText = `${ae} for ${drug} by Manufacturer`;
        const xAxisLabelText = 'Count';
            
        const parent = d3.select("#charts");
        const menu = d3.select("#menu");

        var max = 0;
        var countByPercentageBool = false;
        
        parent
            .selectAll('*')
            .remove();

        menu
            .selectAll('*')
            .remove();

        menu
            .append("button")
            .on("click", selectDrugInitiate)
            .attr("class", "back")
            .text("Back")
            // .style("position", "float")

        const sliderDiv = menu.append('div')
            .style('width', 'auto')
            .style('height', '150px')
            .style('padding-top', '10px')
            .style('text-align', 'center')
            .attr('id', 'sliders');

        const zoomLabel = sliderDiv.append('label')
            .attr('id', 'zoomLabel')
            .html('Zoom');

        zoomLabel.append('div')
            .style('width', 'auto')
            .style('height', '0px');

        const zoomSlider = zoomLabel.append('input')
            .attr('id', 'zoom')
            .attr('type', 'range')
            .attr('min', 0.01)
            .attr('max', 2)
            .attr('value', 1)
            .attr('step', 0.01);

        sliderDiv.append('div')
            .style('width', 'auto')
            .style('height', '20px');

        const rangeLabel = sliderDiv.append('label')
            .attr('id', 'rangeLabel')
            .html('Select Minimum and Maximum Count to Display');
        
        rangeLabel.append('div')
            .style('width', 'auto');
            // .style('height', '10px')

        const rangeSlider = rangeLabel.append('div')
            .style('width', 'auto')
            .style('height', '20px')
            .style('text-align', 'center')
            .attr('class', 'noUiSlider')
            .style('margin-left', '200px')
            .style('margin-right', '200px')
            .attr('id', 'rangeSlider');

        const noUiRangeSlider = document.getElementById('rangeSlider');

        noUiSlider.create(noUiRangeSlider, {
            range: {
                'min': 0,
                'max': max
            },
            step: 1,
            start: [0, max],
            margin: 0, 
            limit: max,
            connect: true,
            direction: 'ltr',
            orientation: 'horizontal',

            behavior: 'tap-drag',
            tooltips: true,

            // pips: {
            //     mode: 'steps',
            //     stepped: true,
            //     density: 
            // }
        })
        parent.append("svg")
            .attr("width",  "1200")
            .attr("height", "600")
            .attr("id", "svg_chart")
            .style('pointer-events', 'none')
            .style('position', 'absolute')
            .style('z-index', 1);

        const svg = d3.select("#svg_chart");
        const width = +svg.attr("width");
        const height = +svg.attr("height");

        const render = data => {

            data.sort(function (a, b) {
                if (a.Count < b.Count) {
                    return 1;
                }
                if (a.Count > b.Count) {
                    return -1;
                }
                return 0;
            })

            const countsData = data.map((o) => o.Count)
            max = Math.max(countsData.reduce((a, b) => Math.max(a, b), -Infinity))

            noUiRangeSlider.noUiSlider.updateOptions({
                range: {
                    'min': 0,
                    'max': Math.ceil(max)
                },
                step: 1,
                start: [0, max],
                margin: 0, 
                limit: max,
                connect: true,
                direction: 'ltr',
                orientation: 'horizontal',

                behavior: 'tap-drag',
                tooltips: true,

                // pips: {
                //     mode: 'steps',
                //     stepped: true,
                //     density: 4
                // }
            });

            const sortData = (type) => {

                if (type === 'descending'){
                    if(countByPercentageBool){
                        data = data.sort(function (a, b) {
                            if (a['Adj Count'] < b['Adj Count']) {
                                return 1;
                            }
                            if (a['Adj Count'] > b['Adj Count']) {
                                return -1;
                            }
                            return 0;
                        })
                    }
                    else {
                        data = data.sort(function (a, b) {
                            if (a.Count < b.Count) {
                                return 1;
                            }
                            if (a.Count > b.Count) {
                                return -1;
                            }
                            return 0;
                        })
                    }   
                }
                else {
                    if(countByPercentageBool){
                        data = data.sort(function (a, b) {
                            if (a['Adj Count'] > b['Adj Count']) {
                                return 1;
                            }
                            if (a['Adj Count'] < b['Adj Count']) {
                                return -1;
                            }
                            return 0;
                        })
                    }
                    else {
                        data = data.sort(function (a, b) {
                            if (a.Count > b.Count) {
                                return 1;
                            }
                            if (a.Count < b.Count) {
                                return -1;
                            }
                            return 0;
                        })
                    } 
                }

                const filterRange = noUiRangeSlider.noUiSlider.get();
                if(countByPercentageBool){
                    var filteredData = data.filter(function(o) {
                        return o['Adj Count'] >= filterRange[0] && o['Adj Count'] <= filterRange[1];
                    });
                }
                else{
                    var filteredData = data.filter(function(o) {
                        return o.Count >= filterRange[0] && o.Count <= filterRange[1];
                    });   
                }

                overHeight = filteredData.length * 50 + margin.left + margin.right;
                range = d3.range(0, overHeight * (filteredData.length + 1), overHeight);

                xScale
                    .domain([0, d3.max(filteredData, xValue)])
                    .range([0, innerWidth]);
                
                yScale
                    .domain(filteredData.map(yValue))
                    .range(range)

                const inner_svg_new = d3.select('#inner_svg')
                    .attr("height", overHeight + "px")
                
                d3.select('#xAxis').call(xAxis);
                const g2_new = d3.select('#g2');

                g2_new.selectAll("#yAxis").call(yAxis);

                g2_new.selectAll('rect')
                    .remove()

                g2_new.selectAll('mybar')
                    .remove()
                    .data(filteredData)
                    .join('rect')
                        .attr('y', d => yScale(yValue(d)))
                        .attr('height', d => yScale.bandwidth())
                        .attr('x', d => 0) 
                        .attr('width', d => 0)
                        .attr('id', d => d["manufacturer"])
                        .attr("fill", function(d,i) {
                            return color(i);
                        })
                    .on("mouseover", (_, d) => {mouseover(d)})
                    .on("mousemove", (e, d) => {mousemove(e, d)})
                    .on("mouseleave", (_, d) => {mouseleave(d)})
                    .on("click", (_, d) => {mouseclick(d)});

                g2_new.selectAll('rect')
                    .transition()
                    .duration(1000)
                    .attr('x', d => 0)
                    .attr('width', d => xScale(xValue(d)));

                zoomSlider.node().value = 1
            }

            const countByElem = () => {
                countByPercentageBool = false;
                var ele = document.getElementsByName('sortBy');
                var checked;
          
                for(var i = 0; i < ele.length; i++) {
                    if(ele[i].checked){
                        checked = ele[i].value
                    }
                }
                console.log(checked)

                const countsData = data.map((o) => o.Count)
                max = Math.max(countsData.reduce((a, b) => Math.max(a, b), -Infinity))

                noUiRangeSlider.noUiSlider.updateOptions({
                    range: {
                        'min': 0,
                        'max': Math.ceil(max)
                    },
                    step: 1,
                    start: [0, max],
                    margin: 0, 
                    limit: max,
                    connect: true,
                    direction: 'ltr',
                    orientation: 'horizontal',

                    behavior: 'tap-drag',
                    tooltips: true,

                    // pips: {
                    //     mode: 'steps',
                    //     stepped: true,
                    //     density: 4
                    // }
                }); 
                sortData(checked)
            }

            const adjustedCount = () => {
                countByPercentageBool = true;
                var ele = document.getElementsByName('sortBy');
                var checked;
          
                for(var i = 0; i < ele.length; i++) {
                    if(ele[i].checked){
                        checked = ele[i].value
                    }
                }
                console.log(checked)
                const countsData = data.map((o) => o['Adj Count'])
                max = Math.max(countsData.reduce((a, b) => Math.max(a, b), -Infinity))

                noUiRangeSlider.noUiSlider.updateOptions({
                    range: {
                        'min': 0,
                        'max': Math.ceil(max)
                    },
                    step: 1,
                    start: [0, max],
                    margin: 0, 
                    limit: max,
                    connect: true,
                    direction: 'ltr',
                    orientation: 'horizontal',

                    behavior: 'tap-drag',
                    tooltips: true,

                    // pips: {
                    //     mode: 'steps',
                    //     stepped: true,
                    //     density: 4
                    // }
                }); 
                sortData(checked)
            }

            const maxRadio = document.createElement('input');
            maxRadio.type = 'radio';
            maxRadio.id = 'descending';
            maxRadio.name = 'sortBy';
            maxRadio.value = 'descending';
            maxRadio.checked = 'checked';
            maxRadio.addEventListener("change", (event) => {
                sortData('descending')
            }) 

            const maxRadioLabel = document.createElement("label");
            maxRadioLabel.innerText = 'Sort Descending Count';
            maxRadioLabel.for = 'maxRadio';
            maxRadioLabel.className = 'radioLabel';

            const minRadio = document.createElement('input');
            minRadio.type = 'radio';
            minRadio.id = 'ascending';
            minRadio.name = 'sortBy';
            minRadio.value = 'ascending';
            minRadio.addEventListener("change", (event) => {
                sortData('ascending')
            }) 
            const minRadioLabel = document.createElement("label");
            minRadioLabel.innerText = 'Sort Ascending Count';
            minRadioLabel.for = 'minRadio';
            minRadioLabel.className = 'radioLabel';

            const radioGroupSort = document.createElement("div");
            radioGroupSort.className = 'radioGroup'

            const menuDOM = document.getElementById('menu')

            radioGroupSort.append(maxRadioLabel);
            maxRadioLabel.append(maxRadio);
            radioGroupSort.append(minRadioLabel);
            minRadioLabel.append(minRadio);
            menuDOM.append(radioGroupSort);

            const countElem = document.createElement('input');
            countElem.type = 'radio';
            countElem.id = 'absoluteCount';
            countElem.name = 'count';
            countElem.value = 'absoluteCount';
            countElem.checked = 'checked';
            countElem.addEventListener("change", (event) => {
                countByElem()
            }) 
            const countLabel = document.createElement("label");
            countLabel.innerText = 'Use Absolute Count';
            countLabel.for = 'absoluteCount';
            countLabel.className = 'radioLabel';

            const countByPercentage = document.createElement('input');
            countByPercentage.type = 'radio';
            countByPercentage.id = 'countByPercentage';
            countByPercentage.name = 'count';
            countByPercentage.value = 'countByPercentage';
            countByPercentage.addEventListener("change", (event) => {
                adjustedCount()
            }) 
            const countByPercentageLabel = document.createElement("label");
            countByPercentageLabel.innerText = 'Count by Percentage';
            countByPercentageLabel.for = 'countByPercentage';
            countByPercentageLabel.className = 'radioLabel';

            const radioGroupCount = document.createElement("div");
            radioGroupCount.className = 'radioGroup'

            radioGroupCount.append(countLabel);
            countLabel.append(countElem);
            radioGroupCount.append(countByPercentageLabel);
            countByPercentageLabel.append(countByPercentage);
            menuDOM.append(radioGroupCount);

            const yValue = d => d['manufacturer'];
            const xValue = d => {
                if(countByPercentageBool) {
                    return d['Adj Count'];
                }
                else{
                    return d['Count'];
                }
            }
            const margin = { top: 50, right: 40, bottom: 77, left: 200 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            var overHeight = data.length * 50 + margin.left + margin.right;

            const xScale = d3.scaleLinear()
                .domain([0, d3.max(data, xValue)])
                .range([0, innerWidth]);

            var range = d3.range(0, overHeight * (data.length + 1), overHeight);

            const yScale = d3.scaleBand()
                .domain(data.map(yValue))
                .range(range)
                .paddingInner(0.1)
                .paddingOuter(0.1);

            const g = svg.append('g')
                .attr('id', 'g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const xAxis = d3.axisBottom(xScale)
                .tickSize(-innerHeight)
                .ticks(5);

            const xAxisG = g.append('g').call(xAxis)
                .attr('id', 'xAxis')
                .attr('transform', `translate(0,${innerHeight})`);

            g.append('text')
                .attr('class', 'title')
                .attr('y', -10)
                .text(titleText);

            xAxisG.append('text')
                .attr('class', 'axis-label')
                .attr('y', 65)
                .attr('x', innerWidth / 2)
                .attr('fill', 'black')
                .text(xAxisLabelText);

            const filler = parent.append('div')
                .style('width', '1200px')
                .style('height', margin.top + 'px')
                .attr('id', 'filler');
            
            const body = parent.append('div')
                .style('overflow-y', 'scroll')
                .style('overflow-x', 'hidden')
                .style('width', '1200px')
                .style('height', innerHeight + "px")
                .attr('id', 'scroll');

            const inner_svg = body.append('svg')
                .attr("width",  "1200px")
                .attr("height", overHeight + "px")
                .attr('id', 'inner_svg')
                .style('display', 'block');

            const g2 = inner_svg.append('g')
                .attr('id', 'g2')
                .attr('transform', `translate(${margin.left},0)`);

            const yAxis = d3.axisLeft(yScale)

            const yAxisG = g2.append('g')
                .attr('id', 'yAxis')
                .call(yAxis)
                .selectAll('.domain, .tick line').remove();
            
            var tooltip = d3.select('#main')
                .append("div")
                .style("visibility", "hidden")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "1px")
                .style("border-radius", "5px")
                .style("position", "absolute")
                .style("z-index", 2)
                .style("padding", "10px");

            var mouseover = function(d) {
                if(countByPercentageBool){
                    tooltip
                    // .html("subgroup: " + subgroupName + "<br>" + "Value: " + subgroupValue)
                    .html("Manufacturer: " + d["manufacturer"] + "<br>" + "Percentage of Total Cases for Manufacturer: " + d["Adj Count"])
                    // .style("opacity", 1)
                    .style("visibility", "visible");
                }
                else{
                    tooltip
                    // .html("subgroup: " + subgroupName + "<br>" + "Value: " + subgroupValue)
                    .html("Manufacturer: " + d["manufacturer"] + "<br>" + "Count: " + d["Count"])
                    // .style("opacity", 1)
                    .style("visibility", "visible");
                }
            };

            var mousemove = function(e, d) {
                tooltip
                    .style("left", (e.pageX + 30) + "px")
                    .style("top", (e.pageY) + "px");
            };

            var mouseleave = function(d) {
                tooltip
                    // .style("opacity", 0)
                    .style("visibility", "hidden");
            };

            var color = d3.scaleOrdinal([`#383867`, `#584c77`, `#33431e`, `#a36629`, `#92462f`, `#b63e36`, `#b74a70`, `#946943`]);

            g2.selectAll('mybar')
                .data(data)
                .join('rect')
                    .attr('y', d => yScale(yValue(d)))
                    .attr('height', d => yScale.bandwidth())
                    .attr('x', d => 0) 
                    .attr('width', d => 0)
                    .attr('id', d => d["manufacturer"])
                    .attr("fill", function(d,i) {
                        return color(i);
                    })
                .on("mouseover", (_, d) => {mouseover(d)})
                .on("mousemove", (e, d) => {mousemove(e, d)})
                .on("mouseleave", (_, d) => {mouseleave(d)})

            g2.selectAll('rect')
                .transition()
                .duration(1000)
                .attr('x', d => 0)
                .attr('width', d => xScale(xValue(d)));

            // TODO: possibly remove axis labels if too small
            function zoomed(value) {
                const new_range = range.map((d) => { return d * value });
                console.log(new_range);
                yScale.range(new_range);
                const new_svg = d3.select('#inner_svg')
                    .attr("height", overHeight * value + "px")
                new_svg.selectAll("rect")
                    .transition()
                    .duration(1000)
                    .attr("y", d => yScale(yValue(d)))
                    .attr("height", yScale.bandwidth());

                //TODO: remove labels if value is bigger than a certain value?
                if(value > 0.5){
                    new_svg.selectAll("#yAxis").call(yAxis);
                }
                else {
                    new_svg.selectAll("#yAxis").call(yAxis);
                }
            }

            zoomSlider.on('change', () => {
                zoomed(zoomSlider.node().value)
            });

            function changeRange(values, handle, unencoded, tap, positions, noUiSlider) {
            // values: Current slider values (array);
            // handle: Handle that caused the event (number);
            // unencoded: Slider values without formatting (array);
            // tap: Event was caused by the user tapping the slider (boolean);
            // positions: Left offset of the handles (array);
            // noUiSlider: slider public Api (noUiSlider);

            //TODO: display filtered data
                const filterRange = values;

                if(countByPercentageBool){
                    var filteredData = data.filter(function(o) {
                        return o['Adj Count'] >= filterRange[0] && o['Adj Count'] <= filterRange[1];
                    });
                }
                else{
                    var filteredData = data.filter(function(o) {
                        return o.Count >= filterRange[0] && o.Count <= filterRange[1];
                    });
                }

                overHeight = filteredData.length * 50 + margin.left + margin.right;
                range = d3.range(0, overHeight * (data.length + 1), overHeight);

                xScale
                    .domain([0, d3.max(filteredData, xValue)])
                    .range([0, innerWidth]);
                
                yScale
                    .domain(filteredData.map(yValue))
                    .range(range)

                const inner_svg_new = d3.select('#inner_svg')
                    .attr("height", overHeight + "px")
                
                d3.select('#xAxis').call(xAxis);
                const g2_new = d3.select('#g2');

                g2_new.selectAll("#yAxis").call(yAxis);

                g2_new.selectAll('rect')
                    .remove()

                g2_new.selectAll('mybar')
                    .remove()
                    .data(filteredData)
                    .join('rect')
                        .attr('y', d => yScale(yValue(d)))
                        .attr('height', d => yScale.bandwidth())
                        .attr('x', d => 0) 
                        .attr('width', d => 0)
                        .attr('id', d => d["manufacturer"])
                        .attr("fill", function(d,i) {
                            return color(i);
                        })
                    .on("mouseover", (_, d) => {mouseover(d)})
                    .on("mousemove", (e, d) => {mousemove(e, d)})
                    .on("mouseleave", (_, d) => {mouseleave(d)})
                    .on("click", (_, d) => {mouseclick(d)});

                g2_new.selectAll('rect')
                    .transition()
                    .duration(1000)
                    .attr('x', d => 0)
                    .attr('width', d => xScale(xValue(d)));

                zoomSlider.node().value = 1
            }
            noUiRangeSlider.noUiSlider.on('change', changeRange);
        };

        // d3.csv(`https://faers-proj.s3.amazonaws.com/BarChart/BarData${drug}_all.csv`).then(data => {
            
        //     var filteredData = data.filter(d => {
        //         return d['Adverse Event'] === ae;
        //     })
        //     filteredData.forEach(d => {
        //         d.Count = +d.Count;
        //     });
        //     render(filteredData.sort(function (a, b) {
        //         if (a.manufacturer < b.manufacturer) {
        //             return -1;
        //         }
        //         if (a.manufacturer > b.manufacturer) {
        //             return 1;
        //         }
        //         return 0;
        //     }));
        // });

        const parameterJSON = JSON.stringify({"drug": drug, "ae": ae});

        fetch('http://ec2-44-212-66-70.compute-1.amazonaws.com:5000/barChartSub', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({"drug": drug, "ae": ae})
        })
        .then((response) => response.json())
        .then((json) => {
            const filteredData = JSON.parse(json['body'])
            filteredData.forEach(d => {
                d.Count = +d.Count;
                d['Adj Count'] = +d['Adj Count'] * 100;
            });
            render(filteredData.sort(function (a, b) {
                if (a.manufacturer < b.manufacturer) {
                    return -1;
                }
                if (a.manufacturer > b.manufacturer) {
                    return 1;
                }
                return 0;
            }));
        });

    }
    
</script>