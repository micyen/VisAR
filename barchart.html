<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="./styles/style.css">
        <link rel="stylesheet" href="./styles/barchart_styles.css">
        </script>
        <!-- <script src="https://unpkg.com/d3@5.6.0/dist/d3.min.js">
        </script> -->
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script> -->
        <!-- <script src="https://cdn.jsdelivr.net/npm/d3-array@3/+esm"></script> -->
    </head>
    <body id="main">
        <div class="sidenav">
            <a href="./dashboard.html">
                <img src="imgs/Home_Icon.svg" alt="Home Icon" style="width:50px;height:50px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    Home
                </div>
            </a>
            <a href="./forcegraph.html">
                <img src="imgs/Bipartite_Graph_Icon.svg" alt="Bipartite Icon" style="width:100px;height:100px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    Graph
                </div>
            </a>
            <a href="./treemap.html">
                <img src="imgs/Treemap_Icon.svg" alt="Treemap Icon" style="width:100px;height:100px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    Treemap
                </div>
            </a>
            <a href="./barchart.html">
                <img src="imgs/Barchart_Icon.svg" alt="Barchart Icon" style="width:100px;height:100px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    Bar Chart
                </div>
            </a>
            <a href="./about.html">
                <img src="imgs/Info_Icon.svg" alt="About Icon" style="width:50px;height:50px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    About
                </div>
            </a>
        </div>
        <div class="centerdiv">
            <div class="header">
                <h1>
                    VisAR
                </h1>
            </div>
            <div class="body" id="charts"></div>
        </div>
    </body>
</html>

<script type="module">

    import {range} from "https://cdn.jsdelivr.net/npm/d3-array@3/+esm";

    // document.getElementById("newchart").addEventListener("click", addChart);
    startChart('Acetaminophen');

    function startChart(drug) {

        const titleText = `Adverse Effects for ${drug}`;
        const xAxisLabelText = 'Count';
               
        const parent = d3.select("#charts");

        parent.append("svg")
            .attr("width",  "1000")
            .attr("height", "600")
            .attr("id", "svg_chart")
            .style('pointer-events', 'none')
            .style('position', 'absolute')
            .style('z-index', 1);

        const svg = d3.select("#svg_chart");
        // const svg = d3.select('svg');

        // const width = parseInt(+svg.attr("width"), 10);
        // const height = parseInt(+svg.attr("height"), 10);
        const width = +svg.attr("width");
        const height = +svg.attr("height");
        console.log(width);
        console.log(height);

        const render = data => {

            const yValue = d => d['AE'];
            const xValue = d => d['Count'];

            const margin = { top: 50, right: 40, bottom: 77, left: 200 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            const overHeight = data.length * 9.225 + margin.left + margin.right;

            const xScale = d3.scaleLinear()
                .domain([0, d3.max(data, xValue) + 50])
                .range([0, innerWidth]);

            // const yScale = d3.scaleBand()
            //     .domain(data.map(yValue))
            //     .range([0, innerHeight])
            //     .padding(0.1);

            const range = d3.range(0, (data.length + 1) * 15000, 15000);
            console.log(range);

            const yScale = d3.scaleBand()
                .domain(data.map(yValue))
                .range(range)
                .padding(0.1);

            // const xScale = d3.scaleBand()
            //     .domain(data.map(xValue))
            //     .range([0, innerWidth])
            //     .padding(0.1);

            // const yScale = d3.scaleLinear()
            //     .domain([0, d3.max(data, yValue)])
            //     .range([0, innerHeight]);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const xAxis = d3.axisBottom(xScale)
                .tickSize(-innerHeight)
                .ticks(5);

            const xAxisG = g.append('g').call(xAxis)
                .attr('transform', `translate(0,${innerHeight})`);

            g.append('text')
                .attr('class', 'title')
                .attr('y', -10)
                .text(titleText);

            xAxisG.append('text')
                .attr('class', 'axis-label')
                .attr('y', 65)
                .attr('x', innerWidth / 2)
                .attr('fill', 'black')
                .text(xAxisLabelText);

            const filler = parent.append('div')
                .style('width', '1000px')
                .style('height', margin.top + 'px')
                .attr('id', 'filler');
            
            const body = parent.append('div')
                .style('overflow-y', 'scroll')
                .style('overflow-x', 'hidden')
                // .style('-webkit-overflow-scrolling', 'touch')
                .style('width', '1000px')
                .style('height', innerHeight + "px")
                // .style('padding-top', margin.top + "px")
                // .style('position', 'absolute')
                //.attr('transform', `translate(0,${margin.top + 'px'})`)
                // .style('height', '600px')
                .attr('id', 'scroll');
            console.log(overHeight);
            console.log(innerHeight);
            const inner_svg = body.append('svg')
                .attr("width",  "1000px")
                //.attr("height", overHeight)
                .attr("height", overHeight + "px")
                .attr('id', 'inner_svg')
                .style('display', 'block');
                // .call(a => a.append('g').call(yAxis));

            const g2 = inner_svg.append('g')
                // .attr('transform', `translate(${margin.left},${margin.top})`);
                .attr('transform', `translate(${margin.left},0)`);

                
            const yAxis = d3.axisLeft(yScale)
                // .call(g => g.select('.domain'.remove()))
                // .call(g => g.select('.tick:last-of-type text').clone())
                //     .attr('y', 3)
                //     .attr('text-anchor', 'start')
                //     .attr('font-weight', 'bold)')
                //     .text(data.y))

            const yAxisG = g2.append('g').call(yAxis)
                .selectAll('.domain, .tick line').remove();
                
            // g.append('g')
            //     .call(d3.axisLeft(yScale))
            //     .selectAll('.domain, .tick line')
            //         .remove();

            // g.selectAll('rect').data(data)
            //     .enter().append('rect')
            //         .attr('y', d => yScale(yValue(d)))
            //         .attr('width', d => xScale(xValue(d)))
            //         .attr('height', yScale.bandwidth());
            
            var tooltip = d3.select('#main')
                .append("div")
                // .style("opacity", 0)
                .style("visibility", "hidden")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "1px")
                .style("border-radius", "5px")
                .style("position", "absolute")
                .style("z-index", 2)
                .text("hi")
                .style("padding", "10px");

            var mouseover = function(d) {
                // var subgroupValue = d.data[subgroupName];
                tooltip
                    // .html("subgroup: " + subgroupName + "<br>" + "Value: " + subgroupValue)
                    .html("Adverse Effect: " + d["AE"] + "<br>" + "Count: " + d["Count"])
                    // .style("opacity", 1)
                    .style("visibility", "visible");
            };

            var mousemove = function(e, d) {
                tooltip
                    .style("left", (e.pageX + 30) + "px")
                    .style("top", (e.pageY) + "px");
            };

            var mouseleave = function(d) {
                tooltip
                    // .style("opacity", 0)
                    .style("visibility", "hidden");
            };

            var mouseclick = function(d) {
                tooltip
                    // .style("opacity", 0)
                    .style("visibility", "hidden");
                addChart(d["AE"]);
            }

            g2.selectAll('mybar')
                .data(data)
                .join('rect')
                    .attr('y', d => yScale(yValue(d)))
                    .attr('height', d => yScale.bandwidth())
                    .attr('x', d => 0) 
                    .attr('width', d => 0)
                    .attr('id', d => d['AE'])
                    .style("cursor", "pointer")
                .on("mouseover", (_, d) => {mouseover(d)})
                .on("mousemove", (e, d) => {mousemove(e, d)})
                .on("mouseleave", (_, d) => {mouseleave(d)})
                .on("click", (_, d) => {mouseclick(d)});

            // g.selectAll('rect').data(data)
            //     .enter().append('rect')
            //         .attr('y', d => yScale(yValue(d)))
            //         .attr('width', d => xScale(xValue(d)))
            //         .attr('height', yScale.bandwidth());

            g2.selectAll('rect')
                .transition()
                .duration(1000)
                .attr('x', d => 0)
                .attr('width', d => xScale(xValue(d)))
                // .delay((d, i) => {console.log(i); return i * 100});
        };

        d3.csv('./data/BarChart_ACETAMINOPHEN_all.csv').then(data => {
            // console.log(data)
            var aggr_data = {}
            var aggr_data_list = []
            function aggregate(_callback){
                Object.entries(data).forEach((entry) => {
                    const ae = entry[1]['Adverse Event'];
                    const count = entry[1]['Count'];
                    if (ae in aggr_data) {
                        aggr_data[ae] += +count;
                    }
                    else {
                        aggr_data[ae] = +count;
                    }
                });
                aggr_data_list = Object.keys(aggr_data).sort().map((key) => ({'AE': key, 'Count': +aggr_data[key]}));
                console.log("Biggest");
                console.log(aggr_data_list.find(e => e['Count'] >= '900'));
                _callback();
            }

            function aggregate2(){
                aggregate(function() {
                    render(aggr_data_list);
                })
            }

            aggregate2();
            // filteredData.forEach(d => {
            //     d.Count = +d.Count;
            // });
            // render(aggr_data);
        });
    }

    function addChart(ae) {
        console.log("button");
        console.log(ae);
        const drug = 'Acetaminophen'
        const titleText = `${ae} for ${drug} by Manufacturer`;
        const xAxisLabelText = 'Count';
        
        const parent = d3.select("#charts");

        parent
            .selectAll('*')
            .remove();
        
        parent
            .append("svg")
            .attr("width",  "1000")
            .attr("height", "800")
            .attr("id", "svg1");

        parent
            .append("button")
            .attr("class", "back")
            .text("Back")

        const svg = d3.select('#svg1');
        // const svg = d3.select('svg');

        // const width = parseInt(+svg.attr("width"), 10);
        // const height = parseInt(+svg.attr("height"), 10);
        const width = +svg.attr("width");
        const height = +svg.attr("height");
        console.log(width);
        console.log(height);

        const render = data => {
            const yValue = d => d['GroupBy'];
            const xValue = d => d['Count'];
            const margin = { top: 50, right: 40, bottom: 77, left: 200 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const xScale = d3.scaleLinear()
                .domain([0, d3.max(data, xValue)])
                .range([0, innerWidth]);

            const yScale = d3.scaleBand()
                .domain(data.map(yValue))
                .range([0, innerHeight])
                .padding(0.1);

            // const xScale = d3.scaleBand()
            //     .domain(data.map(xValue))
            //     .range([0, innerWidth])
            //     .padding(0.1);

            // const yScale = d3.scaleLinear()
            //     .domain([0, d3.max(data, yValue)])
            //     .range([0, innerHeight]);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const xAxis = d3.axisBottom(xScale)
                .tickSize(-innerHeight);

            g.append('g')
                .call(d3.axisLeft(yScale))
                .selectAll('.domain, .tick line')
                    .remove();

            const xAxisG = g.append('g').call(xAxis)
                .attr('transform', `translate(0,${innerHeight})`);

            xAxisG.append('text')
                .attr('class', 'axis-label')
                .attr('y', 65)
                .attr('x', innerWidth / 2)
                .attr('fill', 'black')
                .text(xAxisLabelText);

            // g.selectAll('rect').data(data)
            //     .enter().append('rect')
            //         .attr('y', d => yScale(yValue(d)))
            //         .attr('width', d => xScale(xValue(d)))
            //         .attr('height', yScale.bandwidth());

            g.selectAll('rect').data(data)
                .enter().append('rect')
                    .attr('y', d => yScale(yValue(d)))
                    .attr('width', d => xScale(xValue(d)))
                    .attr('height', yScale.bandwidth());

            g.append('text')
                .attr('class', 'title')
                .attr('y', -10)
                .text(titleText);
        };

        d3.csv('./data/BarChart_ACETAMINOPHEN_all.csv').then(data => {
            var filteredData = data.filter(d => {
                return d['Adverse Event'] === ae;
            })
            filteredData.forEach(d => {
                d.Count = +d.Count;
            });
            console.log(filteredData);
            render(filteredData);
        });
    }

    
</script>