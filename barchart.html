<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="./styles/style.css">
        <link rel="stylesheet" href="./styles/barchart_styles.css">
        <!-- <script src="https://unpkg.com/d3@5.6.0/dist/d3.min.js">
        </script> -->
        <script src="https://d3js.org/d3.v7.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/d3-scale@4"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css">
        <!-- <script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script> -->
        <!-- <script src="https://cdn.jsdelivr.net/npm/d3-array@3/+esm"></script> -->
    </head>
    <body id="main">
        <div class="sidenav">
            <a href="./dashboard.html">
                <img src="imgs/Home_Icon.svg" alt="Home Icon" style="width:50px;height:50px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    Home
                </div>
            </a>
            <a href="./forcegraph.html">
                <img src="imgs/Graph_Icon.svg" alt="Bipartite Icon" style="width:100px;height:100px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    Graph
                </div>
            </a>
            <a href="./treemap.html">
                <img src="imgs/Treemap_Icon.svg" alt="Treemap Icon" style="width:100px;height:100px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    Treemap
                </div>
            </a>
            <a href="./barchart.html">
                <img src="imgs/Barchart_Icon.svg" alt="Barchart Icon" style="width:100px;height:100px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    Bar Chart
                </div>
            </a>
            <a href="./about.html">
                <img src="imgs/Info_Icon.svg" alt="About Icon" style="width:50px;height:50px;margin-left:auto;margin-right:auto;display:block;">
                <div style="text-align:center">
                    About
                </div>
            </a>
        </div>
        <div class="centerdiv">
            <div class="header">
                <h1>
                    VisAR
                </h1>
            </div>
            <div class="menu" id="menu"></div>
            <div class="body" id="charts"></div>
        </div>
    </body>
</html>

<script type="module">

    import {range} from "https://cdn.jsdelivr.net/npm/d3-array@3/+esm";

    // document.getElementById("newchart").addEventListener("click", addChart);
    // startChart('Acetaminophen');
    selectDrugInitiate();

    function selectDrugInitiate() {

        fetch('https://faers-proj.s3.amazonaws.com/Data/DrugList.txt')
        .then((response) => response.text())
        .then((text) => {
            var druglist = text.split("\n");
            const parent = document.getElementById("charts");
            const menu = document.getElementById("menu");
            menu.replaceChildren();
            parent.replaceChildren();

            const select = document.createElement("select");
            select.id = "drug";

            const drugLabel = document.createElement('label');
            drugLabel.textContent = 'Drug: ';
            drugLabel.appendChild(select);

            menu.appendChild(drugLabel);

            for (var i = 0; i < druglist.length; i++) {
                var option = document.createElement("option");
                option.value = druglist[i];
                option.text = druglist[i];
                select.appendChild(option);
            }

            const button = document.createElement("button");
            button.onclick = () => {
                const selection = document.getElementById("drug").value;
                startChart(selection)
            }
            button.id = "submit";
            button.innerText = "Submit";
            menu.appendChild(document.createElement('br'));
            menu.appendChild(document.createElement('br'));
            menu.appendChild(button);
        });
    }

    function startChart(drug) {

        const titleText = `Adverse Effects for ${drug}`;
        const xAxisLabelText = 'Count';
               
        const parent = d3.select("#charts");
        const menu = d3.select("#menu");
        
        parent
            .selectAll('*')
            .remove();

        menu
            .selectAll('*')
            .remove();

        menu
            .append("button")
            .on("click", selectDrugInitiate)
            .attr("class", "back")
            .text("Back")
            // .style("position", "float")

        const sliderDiv = parent.append('div')
            .style('width', 'auto')
            .style('height', '150px')
            .style('padding-top', '10px')
            .style('text-align', 'center')
            .attr('id', 'sliders');

        const zoomLabel = sliderDiv.append('label')
            .attr('id', 'zoomLabel')
            .html('Zoom');

        zoomLabel.append('div')
            .style('width', 'auto')
            .style('height', '0px')

        const zoomSlider = zoomLabel.append('input')
            .attr('id', 'zoom')
            .attr('type', 'range')
            .attr('min', 0.01)
            .attr('max', 2)
            .attr('value', 1)
            .attr('step', 0.01);

        sliderDiv.append('div')
            .style('width', 'auto')
            .style('height', '20px')

        const rangeLabel = sliderDiv.append('label')
            .attr('id', 'rangeLabel')
            .html('Zoom')
        
        rangeLabel.append('div')
            .style('width', 'auto')
            .style('height', '10px')

        const rangeSlider = rangeLabel.append('div')
            .style('width', 'auto')
            .style('height', '20px')
            .style('text-align', 'center')
            .attr('class', 'noUiSlider')
            .style('margin-left', '200px')
            .style('margin-right', '200px')
            .attr('id', 'rangeSlider');

        noUiSlider.create(document.getElementById('rangeSlider'), {
            range: {
                'min': 0,
                'max': 100
            },
            step: 10,
            start: [0, 100],
            margin: 0, 
            limit: 100,
            connect: true,
            direction: 'ltr',
            orientation: 'horizontal',

            behavior: 'tap-drag',
            tooltips: true,

            pips: {
                mode: 'steps',
                stepped: true,
                density: 4
            }
        })

        // var valueDivs = [
        //     document.getElementById('range-value-1'),
        //     document.getElementById('range-value-2'),
        //     document.getElementById('range-value-3'),
        //     document.getElementById('range-value-4')
        // ]

        // var diffDivs = [
        //     document.getElementById('range-diff-1'),
        //     document.getElementById('range-diff-2'),
        //     document.getElementById('range-diff-3')
        // ]

        // sliders.noUiSlider.on('update', function (values, handle) {
        //     valuesDivs[handle].innerHTML = values[handle];
        //     diffDivs[0].innerHTML = values[1] - values[0];
        //     diffDivs[1].innerHTML = values[2] - values[1];
        //     diffDivs[2].innerHTML = values[3] - values[2];
        // })

        // const sliderDivDOM = document.getElementById("sliders");
        // sliderDivDOM.appendChild(zoom);

        // const slider_div.append('')

        parent.append("svg")
            .attr("width",  "1200")
            .attr("height", "600")
            .attr("id", "svg_chart")
            .style('pointer-events', 'none')
            .style('position', 'absolute')
            .style('z-index', 1);

        const svg = d3.select("#svg_chart");
        const width = +svg.attr("width");
        const height = +svg.attr("height");
        console.log(width);
        console.log(height);

        const render = data => {

            data.sort(function (a, b) {
                if (a.Count < b.Count) {
                    return 1;
                }
                if (a.Count > b.Count) {
                    return -1;
                }
                return 0;
            })

            const yValue = d => d['AE'];
            const xValue = d => d['Count'];

            const margin = { top: 50, right: 40, bottom: 77, left: 300 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;
            const overHeight = data.length * 50 + margin.left + margin.right;

            const xScale = d3.scaleLinear()
                .domain([0, d3.max(data, xValue)])
                .range([0, innerWidth]);

            // const yScale = d3.scaleBand()
            //     .domain(data.map(yValue))
            //     .range([0, innerHeight])
            //     .padding(0.1);

            // const range = d3.range(0, (data.length + 1) * 15000, 15000);
            const range = d3.range(0, overHeight * (data.length + 1), overHeight);

            console.log(range);

            const yScale = d3.scaleBand()
                .domain(data.map(yValue))
                .range(range)
                .paddingInner(0.1)
                .paddingOuter(0.1);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const xAxis = d3.axisBottom(xScale)
                .tickSize(-innerHeight)
                .ticks(5);

            const xAxisG = g.append('g').call(xAxis)
                .attr('transform', `translate(0,${innerHeight})`);

            g.append('text')
                .attr('class', 'title')
                .attr('y', -10)
                .text(titleText);

            xAxisG.append('text')
                .attr('class', 'axis-label')
                .attr('y', 65)
                .attr('x', innerWidth / 2)
                .attr('fill', 'black')
                .text(xAxisLabelText);

            const filler = parent.append('div')
                .style('width', '1200px')
                .style('height', margin.top + 'px')
                .attr('id', 'filler');
            
            const body = parent.append('div')
                .style('overflow-y', 'scroll')
                .style('overflow-x', 'hidden')
                .style('width', '1200px')
                .style('height', innerHeight + "px")
                .attr('id', 'scroll');

            console.log("overHeight " + overHeight);
            console.log("innerHeight " + innerHeight);
            const inner_svg = body.append('svg')
                .attr("width",  "1200px")
                .attr("height", overHeight + "px")
                .attr('id', 'inner_svg')
                .style('display', 'block');

            const g2 = inner_svg.append('g')
                .attr('transform', `translate(${margin.left},0)`);

            const yAxis = d3.axisLeft(yScale)

            const yAxisG = g2.append('g').call(yAxis)
                .selectAll('.domain, .tick line').remove();
            
            var tooltip = d3.select('#main')
                .append("div")
                // .style("opacity", 0)
                .style("visibility", "hidden")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "1px")
                .style("border-radius", "5px")
                .style("position", "absolute")
                .style("z-index", 2)
                .style("padding", "10px");

            var mouseover = function(d) {
                tooltip
                    // .html("subgroup: " + subgroupName + "<br>" + "Value: " + subgroupValue)
                    .html("Adverse Effect: " + d["AE"] + "<br>" + "Count: " + d["Count"])
                    // .style("opacity", 1)
                    .style("visibility", "visible");
            };

            var mousemove = function(e, d) {
                tooltip
                    .style("left", (e.pageX + 30) + "px")
                    .style("top", (e.pageY) + "px");
            };

            var mouseleave = function(d) {
                tooltip
                    // .style("opacity", 0)
                    .style("visibility", "hidden");
            };

            var mouseclick = function(d) {
                tooltip
                    // .style("opacity", 0)
                    .style("visibility", "hidden");
                addChart(drug, d["AE"]);
            }

            var color = d3.scaleOrdinal([`#383867`, `#584c77`, `#33431e`, `#a36629`, `#92462f`, `#b63e36`, `#b74a70`, `#946943`]);

            g2.selectAll('mybar')
                .data(data)
                .join('rect')
                    .attr('y', d => yScale(yValue(d)))
                    .attr('height', d => yScale.bandwidth())
                    .attr('x', d => 0) 
                    .attr('width', d => 0)
                    .attr('id', d => d['AE'])
                    .style("cursor", "pointer")
                    .attr("fill", function(d,i) {
                        return color(i);
                    })
                .on("mouseover", (_, d) => {mouseover(d)})
                .on("mousemove", (e, d) => {mousemove(e, d)})
                .on("mouseleave", (_, d) => {mouseleave(d)})
                .on("click", (_, d) => {mouseclick(d)});

            // g.selectAll('rect').data(data)
            //     .enter().append('rect')
            //         .attr('y', d => yScale(yValue(d)))
            //         .attr('width', d => xScale(xValue(d)))
            //         .attr('height', yScale.bandwidth());

            g2.selectAll('rect')
                .transition()
                .duration(1000)
                .attr('x', d => 0)
                .attr('width', d => xScale(xValue(d)))
                // .delay((d, i) => {console.log(i); return i * 100});

            // TODO: Figure out this zoom function
            // function zoom(svg) {
            //     const extent = [[margin.left, margin.top], [width - margin.right, height - margin.top]];

            //     svg.call(d3.zoom()
            //         .scaleExtent([1, 8])
            //         .translateExtent(extent)
            //         .extent(extent)
            //         .on("zoom", zoomed));

            // TODO: STILL WORKING RIGHT HERE position has to be right
            function zoomed(value) {
                const new_range = range.map((d) => { return d * value });
                console.log(new_range);
                yScale.range(new_range);
                const svg = d3.select('#inner_svg')
                    .attr("height", overHeight * value + "px")
                svg.selectAll("rect")
                    .transition()
                    .duration(1000)
                    .attr("y", d => yScale(yValue(d)))
                    .attr("height", yScale.bandwidth());
                svg.selectAll("y-axis").call(yAxis);
            }
            //     }
            // }
            // const range = d3.range(0, overHeight * (data.length + 1), overHeight);

//             console.log(range);

            // const yScale = d3.scaleBand()
            //     .domain(data.map(yValue))
            //     .range(range)
            //     .paddingInner(0.1)
            //     .paddingOuter(0.1);

            zoomSlider.on('change', () => {
                zoomed(zoomSlider.node().value)
                // console.log(value)
            })

            // d3.range(0, overHeight * (data.length + 1), overHeight);
            // var zoom = d3.zoom()
            //   .scaleExtent([1, 10])
            //   .translateExtent([[0, 0], [width, height]])
            //   .on("zoom", zoomed);

        };
        
        d3.csv(`https://faers-proj.s3.amazonaws.com/BarChart/BarData${drug}_all.csv`).then(data => {
        // d3.csv('./data/BarChart_ACETAMINOPHEN_all.csv').then(data => {
            console.log(data);
            console.log(drug)
            var aggr_data = {}
            var aggr_data_list = []
            function aggregate(_callback){
                Object.entries(data).forEach((entry) => {
                    const ae = entry[1]['Adverse Event'];
                    const count = entry[1]['Count'];
                    if (ae in aggr_data) {
                        aggr_data[ae] += +count;
                    }
                    else {
                        aggr_data[ae] = +count;
                    }
                });
                aggr_data_list = Object.keys(aggr_data).sort().map((key) => ({'AE': key, 'Count': +aggr_data[key]}));
                _callback();
            }

            function aggregate2(){
                aggregate(function() {
                    console.log(aggr_data_list);
                    render(aggr_data_list);
                })
            }

            aggregate2();
            // filteredData.forEach(d => {
            //     d.Count = +d.Count;
            // });
            // render(aggr_data);
        });
    }

    function addChart(drug, ae) {

        const titleText = `${ae} for ${drug} by Manufacturer`;
        const xAxisLabelText = 'Count';
            
        const parent = d3.select("#charts");
        const menu = d3.select("#menu");
        
        parent
            .selectAll('*')
            .remove();

        menu
            .selectAll('*')
            .remove();

        menu
            .append("button")
            .on("click", selectDrugInitiate)
            .attr("class", "back")
            .text("Back")
            // .style("position", "float")

        parent.append("svg")
            .attr("width",  "1200")
            .attr("height", "600")
            .attr("id", "svg_chart")
            .style('pointer-events', 'none')
            .style('position', 'absolute')
            .style('z-index', 1);

        const svg = d3.select("#svg_chart");
        // const svg = d3.select('svg');

        // const width = parseInt(+svg.attr("width"), 10);
        // const height = parseInt(+svg.attr("height"), 10);
        const width = +svg.attr("width");
        const height = +svg.attr("height");
        console.log(width);
        console.log(height);

        const render = data => {

            const yValue = d => d['manufacturer'];
            const xValue = d => d['Count'];
            const margin = { top: 50, right: 40, bottom: 77, left: 200 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            const overHeight = data.length * 10 + margin.left + margin.right;

            console.log("overHeight " + overHeight);
            console.log("innerHeight " + innerHeight);

            const xScale = d3.scaleLinear()
                .domain([0, d3.max(data, xValue)])
                .range([0, innerWidth]);

            // const range = d3.range(0, (data.length + 1) * 15000, 15000);
            const range = d3.range(0, overHeight * (data.length + 1), overHeight);
            console.log(range);

            const yScale = d3.scaleBand()
                .domain(data.map(yValue))
                .range(range)
                .paddingInner(0.1)
                .paddingOuter(0.1);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const xAxis = d3.axisBottom(xScale)
                .tickSize(-innerHeight)
                .ticks(5);

            const xAxisG = g.append('g').call(xAxis)
                .attr('transform', `translate(0,${innerHeight})`);

            g.append('text')
                .attr('class', 'title')
                .attr('y', -10)
                .text(titleText);

            xAxisG.append('text')
                .attr('class', 'axis-label')
                .attr('y', 65)
                .attr('x', innerWidth / 2)
                .attr('fill', 'black')
                .text(xAxisLabelText);

            const filler = parent.append('div')
                .style('width', '1200px')
                .style('height', margin.top + 'px')
                .attr('id', 'filler');
            
            const body = parent.append('div')
                .style('overflow-y', 'scroll')
                .style('overflow-x', 'hidden')
                .style('width', '1200px')
                .style('height', innerHeight + "px")
                .attr('id', 'scroll');

            const inner_svg = body.append('svg')
                .attr("width",  "1200px")
                .attr("height", overHeight + "px")
                .attr('id', 'inner_svg')
                .style('display', 'block');

            const g2 = inner_svg.append('g')
                .attr('transform', `translate(${margin.left},0)`);

            const yAxis = d3.axisLeft(yScale)

            const yAxisG = g2.append('g').call(yAxis)
                .selectAll('.domain, .tick line').remove();
            
            var tooltip = d3.select('#main')
                .append("div")
                .style("visibility", "hidden")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "1px")
                .style("border-radius", "5px")
                .style("position", "absolute")
                .style("z-index", 2)
                .style("padding", "10px");

            var mouseover = function(d) {
                tooltip
                    // .html("subgroup: " + subgroupName + "<br>" + "Value: " + subgroupValue)
                    .html("Manufacturer: " + d["manufacturer"] + "<br>" + "Count: " + d["Count"])
                    // .style("opacity", 1)
                    .style("visibility", "visible");
            };

            var mousemove = function(e, d) {
                tooltip
                    .style("left", (e.pageX + 30) + "px")
                    .style("top", (e.pageY) + "px");
            };

            var mouseleave = function(d) {
                tooltip
                    // .style("opacity", 0)
                    .style("visibility", "hidden");
            };

            var color = d3.scaleOrdinal([`#383867`, `#584c77`, `#33431e`, `#a36629`, `#92462f`, `#b63e36`, `#b74a70`, `#946943`]);

            g2.selectAll('mybar')
                .data(data)
                .join('rect')
                    .attr('y', d => yScale(yValue(d)))
                    .attr('height', d => yScale.bandwidth())
                    .attr('x', d => 0) 
                    .attr('width', d => 0)
                    .attr('id', d => d['AE'])
                    .attr("fill", function(d,i) {
                        return color(i);
                    })
                .on("mouseover", (_, d) => {mouseover(d)})
                .on("mousemove", (e, d) => {mousemove(e, d)})
                .on("mouseleave", (_, d) => {mouseleave(d)})

            g2.selectAll('rect')
                .transition()
                .duration(1000)
                .attr('x', d => 0)
                .attr('width', d => xScale(xValue(d)))
        };


        // d3.csv('./data/BarChart_ACETAMINOPHEN_all.csv').then(data => {
        d3.csv(`https://faers-proj.s3.amazonaws.com/BarChart/BarData${drug}_all.csv`).then(data => {
            
            var filteredData = data.filter(d => {
                return d['Adverse Event'] === ae;
            })
            filteredData.forEach(d => {
                d.Count = +d.Count;
            });
            console.log(filteredData);
            console.log("here is the filtered data")
            render(filteredData.sort(function (a, b) {
                if (a.manufacturer < b.manufacturer) {
                    return -1;
                }
                if (a.manufacturer > b.manufacturer) {
                    return 1;
                }
                return 0;
            }));
        });
    }

    
</script>